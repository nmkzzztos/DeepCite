<script>
    /**
     * Math Formula Copy Functionality - Inline version
     */
    (function () {
        'use strict';

        function initMathCopy() {
            const mathElements = document.querySelectorAll('semantics:not([data-copy-ready])');

            mathElements.forEach(function (element) {
                element.setAttribute('data-copy-ready', 'true');
                element.setAttribute('tabindex', '0');
                element.setAttribute('role', 'button');
                element.setAttribute('aria-label', 'Click to copy formula');
                element.style.cursor = 'pointer';

                element.addEventListener('click', handleMathCopy);
                element.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        handleMathCopy.call(this, e);
                    }
                });
            });
        }

        function handleMathCopy(event) {
            event.preventDefault();
            event.stopPropagation();

            const element = this;
            let textToCopy = '';

            const annotation = element.querySelector('annotation');
            if (annotation) {
                textToCopy = annotation.textContent.trim();
            } else {
                textToCopy = element.textContent.trim();
            }

            copyToClipboard(textToCopy, element);
        }

        function copyToClipboard(text, element) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(function () {
                    showCopiedFeedback(element);
                }).catch(function (err) {
                    fallbackCopy(text, element);
                });
            } else {
                fallbackCopy(text, element);
            }
        }

        function fallbackCopy(text, element) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);

                if (successful) {
                    showCopiedFeedback(element);
                }
            } catch (err) {
                console.error('Failed to copy formula:', err);
            }
        }

        function showCopiedFeedback(element) {
            element.classList.add('copying');
            element.classList.add('copied');

            setTimeout(function () {
                element.classList.remove('copying');
            }, 300);

            setTimeout(function () {
                element.classList.remove('copied');
            }, 2000);
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMathCopy);
        } else {
            initMathCopy();
        }

        // Re-initialize for SPA navigation
        let currentLocation = location.pathname;
        const observer = new MutationObserver(function () {
            if (location.pathname !== currentLocation) {
                currentLocation = location.pathname;
                setTimeout(initMathCopy, 300);
            }
        });

        if (typeof window !== 'undefined') {
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
    })();
</script>